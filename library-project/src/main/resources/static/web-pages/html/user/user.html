<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>User Dashboard - Library Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
      body {
        padding-top: 56px;
      }
      .offcanvas-sidebar {
        width: 250px;
      }
      .list-group-item {
        transition: background-color 0.3s ease;
        cursor: pointer;
      }
      .list-group-item:hover {
        background-color: #f8f9fa;
      }
      td[contenteditable="true"] {
        background-color: #fffbe6;
        outline: none;
      }
      td[contenteditable="true"]:focus {
        background-color: #ffffcc;
      }
      img.book-cover {
        height: 60px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-outline-light me-3"
          type="button" data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasSidebar">
          <i class="bi bi-list" id="toggleIcon"></i>
        </button>
        <a class="navbar-brand" href="User.html"><i class="bi bi-book"></i>
          Library</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <form class="d-flex ms-auto"
            onsubmit="event.preventDefault(); handleSearch();">
            <input id="searchInput" class="form-control me-2" type="search"
              placeholder="Search books" />
            <button class="btn btn-outline-success"
              type="submit">Search</button>
          </form>
          <ul class="navbar-nav ms-3">
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="loadPage('Cart.html')"><i
                  class="bi bi-cart-fill" id="cartIcon"></i> Cart</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start offcanvas-sidebar"
      id="offcanvasSidebar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close"
          data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <div class="list-group">
          <a href="#" onclick="loadPage('Profile.html')"
            class="list-group-item list-group-item-action">Profile</a>
          <a href="#" onclick="loadPage('ReturnBook.html')"
            class="list-group-item list-group-item-action">Return Book</a>
          <a href="#" onclick="loadPage('UserHistory.html')"
            class="list-group-item list-group-item-action">History</a>
          <a href="#" onclick="loadPage('UserContact.html')"
            class="list-group-item list-group-item-action">Contact</a>
          <a href="#" onclick="LogOut('home.html')"
            class="list-group-item list-group-item-action text-danger">Logout</a>
        </div>
      </div>
    </div>

    <main class="container mt-4" id="main-content">
      <h1>Welcome, Explore Our Library</h1>

      <!-- Books Table -->
      <h2>Books List</h2>
      <table class="table table-bordered" id="booksTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author Name</th>
            <th>Description</th>
            <th>Available Copies</th>
            <th>Total Copies</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>
    <script src="../../js/script.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const apiUrl = "http://localhost:8080/api";
      const booksTableBody = document.querySelector("#booksTable tbody");

      function loadPage(page) {
        window.location.href = page;
      }

      function LogOut(redirectPage) {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = redirectPage;
      }

      async function handleSearch() {
        const query = document.getElementById("searchInput").value.trim();
        if (!query) return alert("Please enter a search term");

        try {
          const res = await fetch(`${apiUrl}/books`);
          if (!res.ok) throw new Error();
          const books = await res.json();
          displayBooksInTable(books);
        } catch {
          alert("Search error");
        }
      }

      function displayBooksInTable(books) {
        booksTableBody.innerHTML = "";
        for (const book of books) {
          const categoryDescription = book.category ? book.category.categoryDescription : "N/A";
          const authorName = book.author ? book.author.authorName : "N/A";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${book.bookId}</td>
            <td>${book.bookTitle}</td>
            <td>${authorName}</td>
            <td>${categoryDescription}</td>
            <td>${book.availableCopies}</td>
            <td>${book.totalCopies}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="issueBook(${book.bookId})">Issue Book</button>
            </td>
          `;
          booksTableBody.appendChild(row);
        }
      }

      async function fetchAndDisplayBooks() {
        try {
          const res = await fetch(`${apiUrl}/books`, {
            headers: { "Content-Type": "application/json", Authorization: getAuthorization() },
          });
          if (!res.ok) throw new Error();
          const books = await res.json();
          displayBooksInTable(books);
        } catch {
          alert("Failed to load books");
        }
      }

      function getAuthorization() {
        // Implement your token retrieval or auth logic here if needed
        return "Bearer your-auth-token";
      }

      // Placeholder function for issuing a book
      async function issueBook(bookId) {
  try {
    const borrowRecord = {
      bookId: bookId,
      userId: getUserId() // Replace this with your logic to get the logged-in user ID
    };

    const res = await fetch(`${apiUrl}/borrowRecords`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: getAuthorization()
      },
      body: JSON.stringify(borrowRecord)
    });

    if (!res.ok) throw new Error("Failed to issue book");

    alert("Book issued successfully!");
    fetchAndDisplayBooks();
  } catch (error) {
    alert(error.message);
  }
}


      window.addEventListener("DOMContentLoaded", fetchAndDisplayBooks);
    </script>
    <script src="script.js"></script>
  </body>
</html>
